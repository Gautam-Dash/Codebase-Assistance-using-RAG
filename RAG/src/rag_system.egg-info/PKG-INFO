Metadata-Version: 2.4
Name: rag_system
Version: 0.1.0
Summary: RAG system for semantic code search
Requires-Python: >=3.10
Description-Content-Type: text/markdown

# Codebase RAG System

A production-grade Retrieval-Augmented Generation (RAG) system for semantic search over large codebases with intelligent code understanding and context.

## Features

### ðŸ§  AST-Aware Code Ingestion
- **Language-Specific Parsing**: Uses Abstract Syntax Trees (AST) to understand code structure
- **Intelligent Chunking**: Automatically extracts functions, classes, and logical code units
- **Multi-Language Support**: Python, JavaScript, TypeScript, Java, C++, Go, Rust, Ruby, PHP
- **Rich Metadata**: Preserves code complexity, docstrings, and semantic relationships

### ðŸ” Semantic Retrieval with FAISS
- **Fast Vector Search**: Uses Facebook's FAISS for efficient similarity search
- **Sentence Transformers**: State-of-the-art embedding models
- **Hybrid Search**: Combines semantic and keyword-based retrieval
- **Index Management**: Automatic saving, loading, and incremental updates

### ðŸ¤– LLM-Driven Query Expansion
- **Smart Query Rewriting**: Uses LLMs to expand queries for better coverage
- **Multiple Strategies**: 
  - Synonym expansion
  - Related concepts
  - Implementation patterns
  - Error handling aspects
  - Performance optimization patterns
- **Comprehensive Coverage**: Explores different phrasings and interpretations

### ðŸŽ¯ Cross-Encoder Re-Ranking
- **Intelligent Re-ranking**: Cross-encoder models for precise relevance scoring
- **Multi-Strategy Scoring**: Combines multiple ranking signals
- **Result Diversification**: Avoids redundant results from same file
- **Threshold Filtering**: Configurable confidence thresholds

### ðŸ“Š Commit-Aware Context
- **Git Integration**: Analyzes repository history and commits
- **Impact Analysis**: Shows who last modified code and when
- **Related Changes**: Identifies files changed together
- **Commit Context**: Displays messages and authors for full context

### ðŸ’Ž Clean Streamlit UI
- **Interactive Search**: Real-time code search with visual results
- **Score Visualization**: Shows relevance scores from all stages
- **Code Preview**: Syntax-highlighted code snippets
- **Context Display**: Commit history and related information
- **Advanced Options**: Tunable parameters for search behavior

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Interface                            â”‚
â”‚                  (Streamlit App / CLI)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”          â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”        â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ Searchâ”‚          â”‚Config  â”‚        â”‚Status  â”‚
    â”‚Engine â”‚          â”‚Manager â”‚        â”‚        â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         RAG System (Core Pipeline)             â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
        â”‚                                          â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Query Expansion â”‚            â”‚ Repository         â”‚
    â”‚ - LLM Rewriting â”‚            â”‚ Ingestion          â”‚
    â”‚ - Multi-strategyâ”‚            â”‚ - AST Parsing      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ - Code Chunking    â”‚
                                   â”‚ - Metadata Extract â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Semantic Retrieval       â”‚
    â”‚ - FAISS Index            â”‚
    â”‚ - Embedding Generation   â”‚
    â”‚ - Vector Search          â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Re-Ranking & Scoring     â”‚
    â”‚ - Cross-encoder Models   â”‚
    â”‚ - Score Normalization    â”‚
    â”‚ - Result Diversification â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Context Enrichment       â”‚
    â”‚ - Git Analysis           â”‚
    â”‚ - Commit History         â”‚
    â”‚ - Related Changes        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Installation

### Prerequisites
- Python 3.10+
- Git repository for indexing
- OpenAI API key (for LLM features)

### Setup

1. **Clone and setup environment:**
```bash
cd RAG
python -m venv venv
.\venv\Scripts\activate  # Windows
source venv/bin/activate  # Linux/Mac
```

2. **Install dependencies:**
```bash
pip install -r requirements.txt
```

3. **Configure environment:**
```bash
cp .env.example .env
# Edit .env with your settings:
# - OPENAI_API_KEY
# - REPO_PATH (path to codebase to index)
# - Other optional parameters
```

## Quick Start

### 1. Index a Repository

```bash
python -m cli init --repo-path /path/to/repo
```

This will:
- Scan the repository for supported code files
- Parse code using AST analysis
- Generate embeddings
- Build and save FAISS index

### 2. Search the Codebase

**CLI Search:**
```bash
python -m cli search "authentication middleware"
```

**Interactive Mode:**
```bash
python -m cli interactive
```

**Streamlit UI:**
```bash
streamlit run src/ui/app.py
```

### 3. Check System Status

```bash
python -m cli status
python -m cli config --list
```

## Usage Examples

### Python API

```python
from src.rag_system import RAGSystem

# Initialize system
rag = RAGSystem()

# Load existing index
rag.load_existing_index()

# Search
results = rag.search(
    query="error handling in async functions",
    expand_query=True,
    include_context=True,
    top_k=5
)

# Process results
for result in results:
    chunk = result.ranked_result.result.chunk
    score = result.ranked_result.final_score
    
    print(f"File: {chunk.file_path}")
    print(f"Score: {score:.3f}")
    print(f"Code:\n{chunk.content}\n")
    
    if result.commit_context:
        print(f"Last modified by: {result.commit_context.author}")
```

### CLI Usage

```bash
# Search with custom parameters
python -m cli search "database connection pooling" --top-k 10

# Search without query expansion
python -m cli search "config parsing" --no-expansion

# Search without git context
python -m cli search "logging setup" --no-context

# Interactive search mode
python -m cli interactive
```

### Streamlit UI

Run `streamlit run src/ui/app.py` to access:
- Interactive search interface
- Adjustable parameters (top-k, thresholds)
- Score visualization
- Code preview with syntax highlighting
- Commit history view
- Search analysis dashboard

## Configuration

All settings are in `.env`:

```env
# LLM Settings
OPENAI_API_KEY=your_api_key
LLM_MODEL=gpt-4
EMBEDDING_MODEL=text-embedding-3-small

# Retrieval Settings
FAISS_INDEX_PATH=./data/faiss_index
CHUNK_SIZE=512
CHUNK_OVERLAP=50
TOP_K_RETRIEVAL=10
TOP_K_RANKING=5

# Re-ranking
RERANKER_MODEL=cross-encoder/mmarco-mMiniLMv2-L12-H384-v1
RERANKER_THRESHOLD=0.5

# Repository
REPO_PATH=./repo_to_index
INCLUDE_EXTENSIONS=.py,.js,.ts,.java,.cpp,.c,.go,.rs,.rb,.php
EXCLUDE_PATTERNS=__pycache__,node_modules,.git,.env

# API
API_HOST=0.0.0.0
API_PORT=8000
STREAMLIT_PORT=8501
```

## Components

### Ingestion Module (`src/ingestion/`)
- **code_ingestion.py**: AST parsing, chunking, repository scanning
  - `ASTAnalyzer`: Python AST parsing
  - `LanguageAnalyzer`: Multi-language support
  - `CodeChunker`: Intelligent code chunking
  - `RepositoryIngester`: Full repository processing

### Retrieval Module (`src/retrieval/`)
- **semantic_retriever.py**: FAISS-based semantic search
  - `SemanticRetriever`: Vector search with embeddings
  - `KeywordRetriever`: Keyword-based fallback

### Query Expansion (`src/query_expansion/`)
- **llm_expander.py**: LLM-driven query expansion
  - `QueryExpander`: Basic query expansion
  - `HybridQueryExpander`: Multiple strategies

### Ranking Module (`src/ranking/`)
- **cross_encoder.py**: Re-ranking and scoring
  - `CrossEncoderReranker`: Cross-encoder scoring
  - `EnsembleReranker`: Ensemble strategies

### Context Module (`src/context/`)
- **git_context.py**: Git integration
  - `GitContextManager`: Git history and blame
  - `ContextualRetriever`: Enrichment pipeline

### UI Module (`src/ui/`)
- **app.py**: Streamlit interface
  - Interactive search
  - Configuration controls
  - Result visualization

### Utilities (`src/utils/`)
- **config.py**: Configuration management
- **logger.py**: Logging setup
- **models.py**: Data models and types

## Performance Tuning

### For Large Codebases (>100k files)

```env
# Use smaller chunk size for efficiency
CHUNK_SIZE=256
CHUNK_OVERLAP=25

# Limit retrieval scope
TOP_K_RETRIEVAL=20
TOP_K_RANKING=5

# Use smaller embedding model
EMBEDDING_MODEL=all-MiniLM-L6-v2
```

### For Maximum Accuracy

```env
# Larger chunks for context
CHUNK_SIZE=1024
CHUNK_OVERLAP=100

# More retrieval candidates
TOP_K_RETRIEVAL=50
TOP_K_RANKING=10

# Better embedding model
EMBEDDING_MODEL=sentence-transformers/all-mpnet-base-v2

# Lower threshold
RERANKER_THRESHOLD=0.3
```

## Advanced Features

### Incremental Index Updates

```python
from pathlib import Path
from src.rag_system import RAGSystem

rag = RAGSystem()
rag.load_existing_index()

# Add new files
new_files = [Path("src/new_module.py")]
rag.update_index(new_files)
```

### Batch Processing

```python
from src.retrieval.semantic_retriever import SemanticRetriever

retriever = SemanticRetriever()
retriever.load_index()

queries = [
    "authentication",
    "database connection",
    "error handling"
]

for query in queries:
    results = retriever.search(query, k=5)
    # Process results
```

### Git-Aware Context

```python
from src.context.git_context import GitContextManager

git_ctx = GitContextManager(Path("./repo"))

# Get commit history
commits = git_ctx.get_file_commits("src/main.py", limit=10)

# Analyze impact
for commit in commits:
    print(f"{commit.author}: {commit.message}")
    print(f"Changes: {commit.insertions} inserted, {commit.deletions} deleted")
```

## Troubleshooting

### Index Not Loading
```bash
python -m cli status
# If index not found, rebuild:
python -m cli init
```

### Poor Search Results
- Try enabling query expansion: `search --no-expansion` should be False
- Increase TOP_K_RETRIEVAL before re-ranking
- Lower RERANKER_THRESHOLD

### High Memory Usage
- Reduce CHUNK_SIZE
- Use smaller embedding model
- Process files in batches

### Slow Indexing
- Increase BATCH_SIZE (more memory but faster)
- Use `--parallel` flag when available
- Check EXCLUDE_PATTERNS to skip large directories

## API Reference

See inline documentation in source files for detailed API reference.

Key classes:
- `RAGSystem`: Main orchestrator
- `SemanticRetriever`: Vector search
- `CrossEncoderReranker`: Re-ranking
- `RepositoryIngester`: Code ingestion
- `GitContextManager`: Git history

## Development

### Running Tests
```bash
pytest tests/
pytest -v --cov=src tests/
```

### Code Quality
```bash
black src/
flake8 src/
mypy src/
pre-commit run --all-files
```

## Performance Benchmarks

Typical performance on modern hardware:

| Operation | Time | Notes |
|-----------|------|-------|
| Index 10k files | 5-15 min | Depends on code size |
| Search + Re-rank | 200-500ms | Top-10 retrieval |
| Query expansion | 1-2 sec | Uses LLM |
| Index load | <1 sec | FAISS index |
| Memory (indexed) | 2-5GB | Depends on corpus size |

## Future Enhancements

- [ ] Multi-language LLM support (Claude, Llama)
- [ ] Distributed indexing for very large codebases
- [ ] Fine-tuned domain-specific models
- [ ] Real-time indexing with file watchers
- [ ] Advanced filter capabilities
- [ ] Export/import functionality
- [ ] Performance profiling dashboard
- [ ] Batch API endpoint

## License

MIT License - See LICENSE file for details

## Contributing

Contributions welcome! Please follow:
1. Code style: Black + isort
2. Type hints required
3. Unit tests for new features
4. Update documentation

## Support

For issues and questions:
1. Check the troubleshooting section
2. Review source code documentation
3. Open an issue with reproduction steps

## Citation

If you use this system in research, please cite:

```
@software{rag_system_2024,
  title={Production-Grade Codebase RAG System},
  author={RAG Team},
  year={2024},
  url={https://github.com/...}
}
```

---

**Built with** â¤ï¸ **for developers seeking better code understanding**
